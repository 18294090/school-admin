{% extends "base.html" %}
{%block head%}
{%block title%}<title>{{class_name}} 作业《{{dict["name"]}}》详情</title>{%endblock%}     
{%endblock%}
{% block main%}
<script src={{url_for('static',filename="build/js/echarts.min.js")}}></script>
<div class="container-fluid ">
    <div class="accordion" id="accordionPanelsStayOpenExample">
  <div class="accordion-item">
    <h2 class="accordion-header" id="panelsStayOpen-headingOne">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="true" aria-controls="panelsStayOpen-collapseOne">
        各班统计对比图
      </button>
    </h2>
    <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse" aria-labelledby="panelsStayOpen-headingOne">
      <div class="accordion-body">
       <div class="row">
    <div class="clo-12" style="display: flex; align-items: center; justify-content: center;">
     {{ charts | safe }}   
    </div>
    </div>
      </div>
    </div>
  </div>
  <div class="accordion-item">
    <h2 class="accordion-header" id="panelsStayOpen-headingTwo">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseTwo" aria-expanded="false" aria-controls="panelsStayOpen-collapseTwo">
        班级学生作业详情
      </button>
    </h2>
    <div id="panelsStayOpen-collapseTwo" class="accordion-collapse collapse" aria-labelledby="panelsStayOpen-headingTwo">
      <div class="accordion-body">
        
<div class="row g-4 align-items-center">
  <div class="col-1">
    <label for="select">选择班级:</label>
  </div>
  <div class="col-1">
   <select class="form-select" id="class-select">
    
        {% for cls in classes_ %}
            <option value="{{ cls.class_info.id }}">{{ cls.class_info.class_name }}</option>
        {% endfor %}
    </select>
  </div>
   <div class="col-md-10" id="infor">
            <span class="d-block p-2 bg-primary text-white"> 《{{dict["name"]}}》 <small>未交：{{dict["n_sub"]}}人| 作业总分：{{dict["sum"]}}   | 平均分：{{class_.average}}| 最高分：{{class_.max}} | 最低分：{{class_.min}}</small></span>
        </div>
</div>

<table class="table table-striped table-bordered" id="table">
    <thead>
        <tr>
            <th>
                序号
            </th>
             
            <th>
                姓名
            </th>
            {%for i in range(dict['select'])%}
            <td>{{i+1}}</td>
            {%endfor%}
            <th>
                选择题得分
            </th>
            <th>
                填空题得分
            </th>
            <th>
                总分
            </th>
        </tr>
    </thead>
    <tbody>
        {%for i in jobs%}
        <tr>
            <td>
               {{ loop.index}}
            </td>
            
             <td>
            {{i.stu_.name}}
             
            </td>
            {%for j in range(dict['select'])%}
            
            

            
            <td {%if  js[i.id][j].mark==2%}style="background-color: #8aff8a;"{%elif not js[i.id][j-1]%}{%else%}style="background-color: #ff6868;"{%endif%}>{%if js[i.id][j-1]%}{{js[i.id][j].answer}}{%endif%}</td>
           
            {%endfor%}           
            <td>
                 {%if i.select_mark!=None%}{{i.select_mark}}{%endif%}
            </td>    
            </td>
            <td>
            {%if i.select_mark!=None%}{{i.complete_mark}}{%endif%}
            </td>
            <td>
            {%if i.select_mark!=None%}{{i.mark}}{%endif%}
            </td>
        </tr>
        {%endfor%}
    </tbody>
</table>
      </div>
    </div>
  </div>
  <div class="accordion-item">
    <h2 class="accordion-header" id="panelsStayOpen-headingThree">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseThree" aria-expanded="false" aria-controls="panelsStayOpen-collapseThree">
       各小题答题统计
      </button>
    </h2>
    <div id="panelsStayOpen-collapseThree" class="accordion-collapse collapse" aria-labelledby="panelsStayOpen-headingThree">
      <div class="accordion-body">
            <div class="row g-4 align-items-center">
                <div class="col-1">
                    <label for="select">选择班级:</label>
                </div>
                <div class="col-1">
                    <select class="form-select" id="class1-select">
                    <option value="0">全校</option>
                    {% for cls in classes_ %}
                    <option value="{{ cls.class_info.id }}">{{ cls.class_info.class_name}}</option>
                    {% endfor %}
                    </select>
                </div>
                <div class="col-md-10" >
                    
                </div>

            </div>
                <div class="container-fluid">               
                    <div class="row" id="bar_charts" style="width:100;height:auto"></div>
                </div>
      </div>
    </div>
  </div>
</div>
</div>

<script src={{url_for('static',filename="assets/js/jquery.min.js")}}></script>

<script>
$(document).ready(function() {
    // 页面载入时获取初始数据
    getData();

    // 监听班级下拉框变化事件
    $("#class1-select").on("change", function() {
        getData();
    });

    function getData() {
        // 获取选中的班级ID
        var class_id = $("#class1-select").val();
        // 发送ajax请求
        $.ajax({
            type: "POST",
            
            url: "/job/question_statistics/",
            data: {
                job_id:{{dict["id"]}},
                class_id: class_id,
                'csrf_token':'{{ csrf_token() }}',
            },
            success: function (data) {
                 $('#bar_charts').empty();
                    var barHtmlList=JSON.parse(data)
                    for (var i = 0; i < barHtmlList.length; i++) {
                        var barHtml = barHtmlList[i];
                        var $div = $("<div ></div>").addClass('col-md-2').appendTo($('#bar_charts'));
                        $div.html(barHtml);
        }  
           window.addEventListener('resize', function() {
             var parents= document.getElementsByClassName("col-md");
                for(i = 0;i<parents.length;i++){        
                    var chart = echarts.getInstanceByDom(parents[i]);
                    console.log(chart);
                    chart.resize();
                    }
      
      });
            },
                error: function (xhr, status, error) {
                console.error(error);
                }
                });
}
});

$(document).ready(function() {
    $("#class-select").change(function(event) {
        // 获取选中的班级ID
        var class_id = $(this).val();

        // 发送ajax请求
        $.ajax({
            type: "POST",
            url: "/job/job_info/{{dict["id"]}}",
            data: {
                class_id: class_id,
                job_id:{{dict["id"]}},
                'csrf_token':'{{ csrf_token() }}',
            },
            success: function(response) {
                 $("#table").html($(response).find("#table").html());
                 $("#infor").html($(response).find("#infor").html());

            },
            error: function(error) {
                console.log(error);
            }
        });
    });
});

</script>
{%endblock%}